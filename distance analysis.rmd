---
title: "distance"
author: "Anna Huelemeier"
date: "5/20/2020"
output: html_document
---

# Setup 
Please activate the following packages for the following data analysis. If you haven't installed them yet, run the first chunk first.
*Install and activate packages from the library*
```{r setup, include=FALSE}
my_packages <- c("readr", "ggplot2", "nortest", "grid", "gridExtra", "cowplot", "plyr", "dplyr", "QuantPsyc", "ggpubr", "ggsignif", "ggsci", "FSA", "dunn.test", "knitr", "base", "car", "RDocumentation", "onewaytests", "olsrr", "ggstatsplot", "PMCMRplus", "boot", "schoRsch", "dplyr", "ez", "nlme", "lsmeans", "lme4", "MCMCglmm", "rstatix", "lmerTest", "ggfortify", "lattice", "stringr", "reshape2", "pander", "foreach", "bestNormalize", "Hmisc", "pastecs", "RColorBrewer", "reshape2", "viridis", "scales", "devtools", "shadow", "nlme", "pscl", "aod", "MASS", "wesanderson", "moments", "pgirmess", "Rcpp", "lmerTest", "report", "emmeans", "multcomp", "report", "performance", "see", "parameters", "correlation", "insight", "e1071", "ggExtra", "hrbrthemes", "GGally", "tidyverse", "patchwork", "igraph", "ggraph", "colormap", "ggridges", "lawstat", "sm", "psycho", "rstanarm", "modelbased", "emmeans", "modelbased", "sjPlot", 'reportnormalitytests') # remotes is the developper version of report
library(easypackages)
# packages(my_packages) # install packages if necessary
libraries(my_packages) # load all packages
rm(my_packages)

results <- "/Users/huelemeier/Desktop/results_distance/"
```

# Getting started  
The current section loads and preprocesses the data set for the descriptive and inferential analysis later on.  
*Load the data set and rename the coloumns*
Please consider to write down your path where you store the data!
```{r Loading the Dataset, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
dforiginal <- read_delim("~/Desktop/distance.txt", delim = "\t", escape_double = FALSE, col_names = FALSE, trim_ws = TRUE)
colnames(dforiginal) <- c("id", "session", "trial", "grav", "translating", "articulating", "facing", "my", "mx", "move_line", "traveldistance", "travelduration", "travelvelocity", "tspeed", "nframes", "estimateddistance", "estimatederror", "timestemp", "numsecs", "ground", "block")
dforiginal$condition <- 2 # natural locomotion
dforiginal$condition[dforiginal$articulating == 0] <- 1 # static

# code the combination of condition and walker facing
dforiginal$combination <- 1 # static
dforiginal$combination[dforiginal$condition == 2 & dforiginal$facing == 0] <- 2 # approaching
dforiginal$combination[dforiginal$condition == 2 & dforiginal$facing == 180] <- 3 # leaving

# data$estimatederror_d <- data$estimateddistance-data$traveldistance
# data <- subset(data, id == 4)
table(dforiginal$estimateddistance < 0.9)
data <- subset(dforiginal, estimateddistance > 0.9)
df <- subset(dforiginal, estimateddistance < 0.9)
df <- data.frame(df$id, df$trial, df$block, df$traveldistance, df$travelvelocity, df$ground, df$combination, df$articulating, df$translating, df$facing)


data$ground <- as.factor(data$ground)
data$combination <- as.factor(data$combination)
data$id <- as.factor(data$id)
```


# Descriptives
```{r - mean, median and sd}
round(data %>%
  group_by(travelvelocity, as.numeric(ground), as.numeric(combination)) %>% # grouping variables
  summarise_at(vars(estimatederror), # dependent variable
    list(mean = mean, sd = sd)), 3) # Descriptives

round(data %>%
  group_by(traveldistance) %>% # grouping variables
  summarise_at(vars(estimatederror), # dependent variable
    list(mean = mean, sd = sd)), 3) # Descriptives


# Descriptives // relevant for post hoc analyses to interpret the direction of the effects
## Ground
round(data %>%
  group_by(as.numeric(ground)) %>% # grouping variables
  summarise_at(vars(estimateddistance), # dependent variable
    list(mean = mean, sd = sd, var)), 2) # Descriptives
# Result for both short and long distances: estimates decrease in stripes compared to ground. 1 > 2

## Combination
round(data %>%
  group_by(as.numeric(combination)) %>% # grouping variables
  summarise_at(vars(estimateddistance), # dependent variable
    list(mean = mean, sd = sd,)), 2) # Descrptives
# Result 1> 2 > 3 // Note that short 2>1 does not reach significance

## Interaction effect
round(data %>%
  group_by(as.numeric(ground), as.numeric(combination)) %>% # grouping variables
  summarise_at(vars(estimateddistance), # dependent variable
    list(mean = mean, sd = sd)), 2) # Descriptives

``` 


# Descriptive Plots
*estimated distance*
```{r - plots of estimated distance }
# PLOTS - Distance error in Abhängigkit von der zurückgelegten Distanz (getrennt für zukommen vs weggehen)
walkerlabels <- c("0" = "approaching crowd", "180" = "leaving crowd")
groundlabels <- c("1" = "gravel", "2" = "stripes")
conditionlabels <- c("1" = "static", "2" = "natural locomotion")

plot <- ggplot((data), aes(y = estimateddistance, x = (traveldistance), color = factor(travelvelocity))) +
  ggtitle("Travel distance estimation in the presence of biological motion // all travel speeds") +
  theme_classic2() +
  geom_smooth(method = "lm", alpha = 0.8, se = F, size = 0.5) +
  geom_point(size = 0.6, alpha = 0.5, position = position_jitterdodge(dodge.width = 0.8)) +
  facet_wrap(~ ground * facing * condition, labeller = labeller(facing = walkerlabels, ground = groundlabels, condition = conditionlabels)) +
  # scale_color_manual("travel velocity", values=c("#D9345D","#869ED0","#E38B90"), guide=guide_legend(nrow = 1)) +
  scale_color_manual("travel velocity", values = c("#F3C067", "#87C8C1", "#E06957"), guide = guide_legend(nrow = 1)) +
  theme(
    strip.text.x = element_text(size = 7),
    strip.background = element_rect(color = "white"),
    panel.background = element_rect(fill = "#F9F9F9"),
    axis.title.x = element_text(hjust = 0),
    axis.title.y = element_text(hjust = 1),
    text = element_text(size = 6, family = "Helvetica"),
    element_line(size = 0.1),
    legend.position = "bottom",
    plot.title = element_text(size = 7, family = "Helvetica", hjust = 0, face = "bold"),
    plot.title.position = "plot",
    axis.text = element_text(size = 5),
    legend.key.size = unit(2, "mm")
  ) +
  scale_x_continuous(name = "  traveled distance", breaks = c(4, 5.66, 8, 11.31, 16, 22.63)) +
  scale_y_continuous(name = "estimated distance (in m)        ")
ggsave(plot, file = paste(results, "distance estimation alle Geschwindigkeiten", ".png", sep = ""), units = "in", width = 6, height = 8.4)


# only one velocity
plot <- ggplot(subset(data, travelvelocity == 0.7930), aes(y = estimateddistance, x = (traveldistance), color = factor(facing))) +
  ggtitle("Travel distance estimation in the presence of biological motion // walker speed = observer speed") +
  theme_classic2() +
  geom_smooth(method = "lm", alpha = 0.8, se = F, size = 0.5) +
  geom_point(size = 0.6, alpha = 0.5, position = position_jitterdodge(dodge.width = 0.8)) +
  facet_wrap(~ ground * condition, labeller = labeller(ground = groundlabels, condition = conditionlabels)) +
  scale_color_manual("walker facing", values = c("#2A64AE", "#D9345D"), breaks = c(0, 180), labels = c("approaching", "leaving")) +
  theme(
    strip.text.x = element_text(size = 7),
    strip.background = element_rect(color = "white"),
    panel.background = element_rect(fill = "#F9F9F9"),
    axis.title.x = element_text(hjust = 0),
    axis.title.y = element_text(hjust = 1),
    text = element_text(size = 6, family = "Helvetica"),
    element_line(size = 0.1),
    legend.position = "bottom",
    plot.title = element_text(size = 7, family = "Helvetica", hjust = 0, face = "bold"),
    plot.title.position = "plot",
    axis.text = element_text(size = 5),
    legend.key.size = unit(2, "mm")
  ) +
  scale_x_continuous(name = "   traveled distance", breaks = c(4, 5.66, 8, 11.31, 16, 22.63)) +
  scale_y_continuous(name = "estimated distance (in m)     ")
ggsave(plot, file = paste(results, "distance estimation gleiche Geschwindigkeit", ".png", sep = ""), units = "in", width = 6, height = 8.4)


# error
ggplot(data, aes(y = estimatederror, x = (traveldistance), color = factor(travelvelocity))) +
  ggtitle("Estimation error in the presence of biological motion // all travel speeds") +
  theme_classic2() +
  geom_smooth(method = "lm", alpha = 0.8, se = F, size = 0.5) +
  geom_point(size = 0.6, alpha = 0.5, position = position_jitterdodge(dodge.width = 0.8)) +
  facet_wrap(~ ground * facing, labeller = labeller(facing = walkerlabels, ground = groundlabels)) +
  # scale_color_manual("travel velocity", values=c("#F2D148","#72C5E3","#C83386"), guide=guide_legend(nrow = 1)) +
  scale_color_manual("travel velocity", values = c("#F3C067", "#87C8C1", "#E06957"), guide = guide_legend(nrow = 1)) +
  #  scale_color_manual("travel velocity", values=c("#EDA653","#5E93AF","#B74935"), guide=guide_legend(nrow = 1)) +
  theme(
    strip.text.x = element_text(size = 7),
    strip.background = element_rect(color = "white"),
    panel.background = element_rect(fill = "#F9F9F9"),
    axis.title.x = element_text(hjust = 0),
    axis.title.y = element_text(hjust = 1),
    text = element_text(size = 6, family = "Helvetica"),
    element_line(size = 0.1),
    legend.position = "bottom",
    plot.title = element_text(size = 7, family = "Helvetica", hjust = 0, face = "bold"),
    plot.title.position = "plot",
    axis.text = element_text(size = 5),
    legend.key.size = unit(2, "mm")
  ) +
  scale_x_continuous(name = " traveled distance", breaks = c(4, 5.66, 8, 11.31, 16, 22.63)) +
  scale_y_continuous(name = "estimated distance error (in m)        ")
# ggsave(plot, file=paste(results, "estimation error alle Geschwindigkeiten2", ".png", sep=''), units = "in", width = 6, height = 8.4)


# only one velocity
ggplot(subset(data, travelvelocity == 0.7930), aes(y = estimatederror, x = (traveldistance), color = factor(facing))) +
  ggtitle("Estimation error in the presence of biological motion // walker speed = observer speed") +
  theme_classic2() +
  geom_smooth(method = "lm", alpha = 0.8, se = F, size = 0.5) +
  geom_point(size = 0.6, alpha = 0.5, position = position_jitterdodge(dodge.width = 0.8)) +
  facet_wrap(~ground, labeller = labeller(ground = groundlabels)) +
  scale_color_manual("walker facing", values = c("#2A64AE", "#D9345D"), breaks = c(0, 180), labels = c("approaching", "leaving")) +
  theme(
    strip.text.x = element_text(size = 7),
    strip.background = element_rect(color = "white"),
    panel.background = element_rect(fill = "#F9F9F9"),
    axis.title.x = element_text(hjust = 0),
    axis.title.y = element_text(hjust = 1),
    text = element_text(size = 6, family = "Helvetica"),
    element_line(size = 0.1),
    legend.position = "bottom",
    plot.title = element_text(size = 7, family = "Helvetica", hjust = 0, face = "bold"),
    plot.title.position = "plot",
    axis.text = element_text(size = 5),
    legend.key.size = unit(2, "mm")
  ) +
  scale_x_continuous(name = "  traveled distance", breaks = c(4, 5.66, 8, 11.31, 16, 22.63)) +
  scale_y_continuous(name = "estimated distance error (in m)        ")
# ggsave(plot, file=paste(results, "estimation error gleiche Geschwindigkeit2", ".png", sep=''), units = "in", width =6, height = 4.2)
```
```{r - mean + sd // talk plots}

walkerlabels <- c("0" = "approaching crowd", "180" = "leaving crowd")
groundlabels <- c("1" = "gravel", "2" = "stripes")
conditionlabels <- c("1" = "static", "2" = "natural locomotion")

plot <- ggplot(subset(data, condition == 2 & travelvelocity == 0.7930), aes(y = estimateddistance, x = (traveldistance), color = factor(facing))) +
  ggtitle("Travel distance estimation across velocities in the presence of biological motion") +
  theme_classic2() +
  geom_smooth(method = "lm", alpha = 0.5, se = F, size = 0.3) +
  # geom_point(size=0.6, alpha = 0.5, position = position_jitterdodge(dodge.width=0.8)) +
  facet_wrap(~ ground * condition, labeller = labeller(ground = groundlabels, condition = conditionlabels)) +
  scale_color_manual("walker facing", values = c("#2A64AE", "#D9345D"), breaks = c(0, 180), labels = c("approaching", "leaving")) +
  stat_summary(
    mapping = aes(x = traveldistance, y = estimateddistance),
    fun.ymin = function(z) {
      mean(z) - sd(z)
    },
    fun.ymax = function(z) {
      mean(z) + sd(z)
    },
    fun.y = mean, size = 0.2, position = position_dodge(width = 0.9)
  ) +
  theme(
    strip.text.x = element_text(size = 7),
    strip.background = element_rect(color = "white"),
    panel.background = element_rect(fill = "#F9F9F9"),
    axis.title.x = element_text(hjust = 0),
    axis.title.y = element_text(hjust = 1),
    text = element_text(size = 6, family = "Helvetica"),
    element_line(size = 0.1),
    legend.position = "bottom",
    plot.title = element_text(size = 7, family = "Helvetica", hjust = 0, face = "bold"),
    plot.title.position = "plot",
    axis.text = element_text(size = 5),
    legend.key.size = unit(2, "mm")
  ) +
  scale_x_continuous(name = "        traveled distance", breaks = c(4, 5.66, 8, 11.31, 16, 22.63)) +
  scale_y_continuous(name = "estimated distance (in m)            ")
ggsave(plot, file = paste(results, "natural locomotion mean sd distance estimation eine Geschwindigkeit", ".pdf", sep = ""), units = "in", width = 8.4, height = 8.4)




plot <- ggplot((data), aes(y = estimateddistance, x = (traveldistance), color = factor(travelvelocity))) +
  ggtitle("Travel distance estimation in the presence of biological motion // all travel speeds") +
  theme_classic2() +
  geom_smooth(method = "lm", alpha = 0.8, se = F, size = 0.5) +
  # geom_point(size=0.6, alpha = 0.5, position = position_jitterdodge(dodge.width=0.8)) +
  facet_wrap(~ ground * facing * condition, labeller = labeller(facing = walkerlabels, ground = groundlabels, condition = conditionlabels)) +
  # scale_color_manual("travel velocity", values=c("#D9345D","#869ED0","#E38B90"), guide=guide_legend(nrow = 1)) +
  scale_color_manual("travel velocity", values = c("#F3C067", "#87C8C1", "#E06957"), guide = guide_legend(nrow = 1)) +
  stat_summary(
    mapping = aes(x = traveldistance, y = estimateddistance),
    fun.ymin = function(z) {
      mean(z) - sd(z)
    },
    fun.ymax = function(z) {
      mean(z) + sd(z)
    },
    fun.y = mean, size = 0.4, position = position_dodge(width = 0.9)
  ) +
  theme(
    strip.text.x = element_text(size = 7),
    strip.background = element_rect(color = "white"),
    panel.background = element_rect(fill = "#F9F9F9"),
    axis.title.x = element_text(hjust = 0),
    axis.title.y = element_text(hjust = 1),
    text = element_text(size = 6, family = "Helvetica"),
    element_line(size = 0.1),
    legend.position = "bottom",
    plot.title = element_text(size = 7, family = "Helvetica", hjust = 0, face = "bold"),
    plot.title.position = "plot",
    axis.text = element_text(size = 5),
    legend.key.size = unit(2, "mm")
  ) +
  scale_x_continuous(name = "  traveled distance", breaks = c(4, 5.66, 8, 11.31, 16, 22.63)) +
  scale_y_continuous(name = "estimated distance (in m)        ")
ggsave(plot, file = paste(results, "mean sd distance estimation pro Geschwindigkeit mit linear model", ".pdf", sep = ""), units = "in", width = 14, height = 14)
```
*estimated error*
```{r - plots estimation error for all and the same velocities}
# PLOTS - Distance error in Abhängigkit von der zurückgelegten Distanz (getrennt für zukommen vs weggehen)
walkerlabels <- c("0" = "approaching crowd", "180" = "leaving crowd")
groundlabels <- c("1" = "gravel", "2" = "stripes")
conditionlabels <- c("1" = "static", "2" = "natural locomotion")
# error
ggplot(data, aes(y = estimatederror, x = (traveldistance), color = factor(travelvelocity))) +
  ggtitle("Estimation error in the presence of biological motion // all travel speeds") +
  theme_classic2() +
  geom_smooth(method = "lm", alpha = 0.8, se = F, size = 0.5) +
  geom_point(size = 0.6, alpha = 0.5, position = position_jitterdodge(dodge.width = 0.8)) +
  facet_wrap(~ ground * facing, labeller = labeller(facing = walkerlabels, ground = groundlabels)) +
  # scale_color_manual("travel velocity", values=c("#F2D148","#72C5E3","#C83386"), guide=guide_legend(nrow = 1)) +
  scale_color_manual("travel velocity", values = c("#F3C067", "#87C8C1", "#E06957"), guide = guide_legend(nrow = 1)) +
  #  scale_color_manual("travel velocity", values=c("#EDA653","#5E93AF","#B74935"), guide=guide_legend(nrow = 1)) +
  theme(
    strip.text.x = element_text(size = 7),
    strip.background = element_rect(color = "white"),
    panel.background = element_rect(fill = "#F9F9F9"),
    axis.title.x = element_text(hjust = 0),
    axis.title.y = element_text(hjust = 1),
    text = element_text(size = 6, family = "Helvetica"),
    element_line(size = 0.1),
    legend.position = "bottom",
    plot.title = element_text(size = 7, family = "Helvetica", hjust = 0, face = "bold"),
    plot.title.position = "plot",
    axis.text = element_text(size = 5),
    legend.key.size = unit(2, "mm")
  ) +
  scale_x_continuous(name = " traveled distance", breaks = c(4, 5.66, 8, 11.31, 16, 22.63)) +
  scale_y_continuous(name = "estimated distance error (in m)        ")
ggsave(plot, file = paste(results, "estimation error alle Geschwindigkeiten2", ".png", sep = ""), units = "in", width = 6, height = 8.4)


# only one velocity
ggplot(subset(data, travelvelocity == 0.7930), aes(y = estimatederror, x = (traveldistance), color = factor(facing))) +
  ggtitle("Estimation error in the presence of biological motion // walker speed = observer speed") +
  theme_classic2() +
  geom_smooth(method = "lm", alpha = 0.8, se = F, size = 0.5) +
  geom_point(size = 0.6, alpha = 0.5, position = position_jitterdodge(dodge.width = 0.8)) +
  facet_wrap(~ground, labeller = labeller(ground = groundlabels)) +
  scale_color_manual("walker facing", values = c("#2A64AE", "#D9345D"), breaks = c(0, 180), labels = c("approaching", "leaving")) +
  theme(
    strip.text.x = element_text(size = 7),
    strip.background = element_rect(color = "white"),
    panel.background = element_rect(fill = "#F9F9F9"),
    axis.title.x = element_text(hjust = 0),
    axis.title.y = element_text(hjust = 1),
    text = element_text(size = 6, family = "Helvetica"),
    element_line(size = 0.1),
    legend.position = "bottom",
    plot.title = element_text(size = 7, family = "Helvetica", hjust = 0, face = "bold"),
    plot.title.position = "plot",
    axis.text = element_text(size = 5),
    legend.key.size = unit(2, "mm")
  ) +
  scale_x_continuous(name = "  traveled distance", breaks = c(4, 5.66, 8, 11.31, 16, 22.63)) +
  scale_y_continuous(name = "estimated distance error (in m)        ")
# ggsave(plot, file=paste(results, "estimation error gleiche Geschwindigkeit2", ".png", sep=''), units = "in", width =6, height = 4.2)
```
*individual plots*
```{r - individual plots}
# PLOTS - Distance error in Abhängigkit von der zurückgelegten Distanz (getrennt für zukommen vs weggehen)
walkerlabels <- c("0" = "approaching crowd", "180" = "leaving crowd")
groundlabels <- c("1" = "gravel", "2" = "stripes")
id_list <- unique(data$id)


for (i in seq_along(id_list)) {
  plot <- ggplot(subset(data, id == id_list[i]), aes(y = estimateddistance, x = (traveldistance), color = factor(travelvelocity))) +
    ggtitle("Travel distance estimation in the presence of biological motion // all travel speeds", id_list[i]) +
    theme_classic2() +
    geom_smooth(method = "lm", alpha = 0.8, se = F, size = 0.5) +
    geom_point(size = 0.6, alpha = 0.8) +
    facet_wrap(~ ground * facing, labeller = labeller(facing = walkerlabels, ground = groundlabels)) +
    # scale_color_manual("travel velocity", values=c("#D9345D","#869ED0","#E38B90"), guide=guide_legend(nrow = 1)) +
    scale_color_manual("travel velocity", values = c("#F3C067", "#87C8C1", "#E06957"), guide = guide_legend(nrow = 1)) +
    theme(
      strip.text.x = element_text(size = 7),
      strip.background = element_rect(color = "white"),
      panel.background = element_rect(fill = "#F9F9F9"),
      axis.title.x = element_text(hjust = 0),
      axis.title.y = element_text(hjust = 1),
      text = element_text(size = 6, family = "Helvetica"),
      element_line(size = 0.1),
      legend.position = "bottom",
      plot.title = element_text(size = 7, family = "Helvetica", hjust = 0, face = "bold"),
      plot.title.position = "plot",
      axis.text = element_text(size = 5),
      legend.key.size = unit(2, "mm")
    ) +
    scale_x_continuous(name = "  traveled distance", breaks = c(4, 5.66, 8, 11.31, 16, 22.63)) +
    scale_y_continuous(name = "estimated distance (in m)        ")

  ggsave(plot, file = paste(results, "distance estimation alle Geschwindigkeiten", id_list[i], ".pdf", sep = ""), units = "in", width = 6, height = 4.2)
  print(plot)
}



# only one velocity
for (i in seq_along(id_list)) {
  plot <- ggplot(subset(data, travelvelocity == 0.7930 & id == id_list[i]), aes(y = estimateddistance, x = (traveldistance), color = factor(facing))) +
    ggtitle("Travel distance estimation in the presence of biological motion // walker speed = observer speed", id_list[i]) +
    theme_classic2() +
    geom_smooth(method = "lm", alpha = 0.8, se = F, size = 0.5) +
    geom_point(size = 0.6, alpha = 0.8) +
    facet_wrap(~ground, labeller = labeller(ground = groundlabels)) +
    scale_color_manual("walker facing", values = c("#2A64AE", "#D9345D"), breaks = c(0, 180), labels = c("approaching", "leaving")) +
    theme(
      strip.text.x = element_text(size = 7),
      strip.background = element_rect(color = "white"),
      panel.background = element_rect(fill = "#F9F9F9"),
      axis.title.x = element_text(hjust = 0),
      axis.title.y = element_text(hjust = 1),
      text = element_text(size = 6, family = "Helvetica"),
      element_line(size = 0.1),
      legend.position = "bottom",
      plot.title = element_text(size = 7, family = "Helvetica", hjust = 0, face = "bold"),
      plot.title.position = "plot",
      axis.text = element_text(size = 5),
      legend.key.size = unit(2, "mm")
    ) +
    scale_x_continuous(name = "   traveled distance", breaks = c(4, 5.66, 8, 11.31, 16, 22.63)) +
    scale_y_continuous(name = "estimated distance (in m)     ")
  ggsave(plot, file = paste(results, "distance estimation gleiche Geschwindigkeit", id_list[i], ".pdf", sep = ""), units = "in", width = 6, height = 4.2)
  print(plot)
}

# error
walkerlabels <- c("0" = "approaching crowd", "180" = "leaving crowd")

for (i in seq_along(id_list)) {
  ggplot(subset(data, id == id_list[i]), aes(y = estimatederror_d, x = (traveldistance), color = factor(travelvelocity))) +
    ggtitle("Estimation error in the presence of biological motion // all travel speeds", id_list[i]) +
    theme_classic2() +
    geom_smooth(method = "lm", alpha = 0.8, se = F, size = 0.5) +
    geom_point(size = 0.6, alpha = 0.8) +
    facet_wrap(~ ground * facing, labeller = labeller(facing = walkerlabels, ground = groundlabels)) +
    # scale_color_manual("travel velocity", values=c("#F2D148","#72C5E3","#C83386"), guide=guide_legend(nrow = 1)) +
    scale_color_manual("travel velocity", values = c("#F3C067", "#87C8C1", "#E06957"), guide = guide_legend(nrow = 1)) +
    #  scale_color_manual("travel velocity", values=c("#EDA653","#5E93AF","#B74935"), guide=guide_legend(nrow = 1)) +
    theme(
      strip.text.x = element_text(size = 7),
      strip.background = element_rect(color = "white"),
      panel.background = element_rect(fill = "#F9F9F9"),
      axis.title.x = element_text(hjust = 0),
      axis.title.y = element_text(hjust = 1),
      text = element_text(size = 6, family = "Helvetica"),
      element_line(size = 0.1),
      legend.position = "bottom",
      plot.title = element_text(size = 7, family = "Helvetica", hjust = 0, face = "bold"),
      plot.title.position = "plot",
      axis.text = element_text(size = 5),
      legend.key.size = unit(2, "mm")
    ) +
    scale_x_continuous(name = "  traveled distance", breaks = c(4, 5.66, 8, 11.31, 16, 22.63)) +
    scale_y_continuous(name = "estimated distance error (in m)        ")
  # ggsave(plot, file=paste(results, "estimation error alle Geschwindigkeiten",id_list[i], ".pdf", sep=''), units = "in", width = 6, height = 4.2)
  print(plot)
}

# only one velocity
for (i in seq_along(id_list)) {
  plot <- ggplot(subset(data, travelvelocity == 0.7930 & id == id_list[i]), aes(y = estimatederror_d, x = (traveldistance), color = factor(facing))) +
    ggtitle("Estimation error in the presence of biological motion // walker speed = observer speed", id_list[i]) +
    theme_classic2() +
    geom_smooth(method = "lm", alpha = 0.8, se = F, size = 0.5) +
    geom_point(size = 0.6, alpha = 0.8) +
    facet_wrap(~ground, labeller = labeller(ground = groundlabels)) +
    scale_color_manual("walker facing", values = c("#2A64AE", "#D9345D"), breaks = c(0, 180), labels = c("approaching", "leaving")) +
    theme(
      strip.text.x = element_text(size = 7),
      strip.background = element_rect(color = "white"),
      panel.background = element_rect(fill = "#F9F9F9"),
      axis.title.x = element_text(hjust = 0),
      axis.title.y = element_text(hjust = 1),
      text = element_text(size = 6, family = "Helvetica"),
      element_line(size = 0.1),
      legend.position = "bottom",
      plot.title = element_text(size = 7, family = "Helvetica", hjust = 0, face = "bold"),
      plot.title.position = "plot",
      axis.text = element_text(size = 5),
      legend.key.size = unit(2, "mm")
    ) +
    scale_x_continuous(name = "  traveled distance", breaks = c(4, 5.66, 8, 11.31, 16, 22.63)) +
    scale_y_continuous(name = "estimated distance error (in m)        ")
  # ggsave(plot, file=paste(results, "estimation error gleiche Geschwindigkeit", id_list[i],".pdf", sep=''), units = "in", width =6, height = 4.2)
  print(plot)
}
```



# Inferential analysis
```{r - correlation analysis // check. Können die Versuchspersonen überhaupt schätzen?}
# normal distribution?
by(data, data$travelvelocity, function (data) (ad.test(subset(data, ground == 1 & combination == 1)$estimateddistance))) # A = 3.27 als kleinster, signifikanter Wert aller Kombinationen

data %>% 
  group_by(ground, combination) %>%
  select(estimateddistance, traveldistance) %>%
  correlation(method="kendall", p_adjust = "holm")

# Gaussian Graphical Models (GGMs)
# Such partial correlations can also be represented as Gaussian Graphical Models (GGM), an increasingly popular tool in psychology. A GGM traditionally includes a set of variables depicted as circles (“nodes”), and a set of lines that visualize relationships between them, which thickness represents the strength of association (see Bhushan et al., 2019).

data %>%
  group_by(ground, combination) %>%
  select(estimateddistance, traveldistance) %>%
  correlation(partial = TRUE) %>%
  plot() # keine Beziehung der Sachen untereinander.

ggplot(data=data, aes(x=traveldistance, y=estimateddistance, group=c(id), colour="gray"), legend=FALSE) +
  geom_smooth(method=lm, se=FALSE, fullrange=FALSE, lty=1, size=.5, color="gray40") +
  geom_smooth(aes(group=1), method=lm, se=FALSE, fullrange=FALSE, lty=1, size=2, color="blue") +
 ylab("estimated distance") + xlab("traveled distance") +
  theme_classic() +
  theme(axis.title=element_text(size=18),
        axis.text=element_text(size=14),
        plot.title=element_text(size=18, hjust=.5)) +
  ggtitle("Within-Person Association Plot\n traveled distance and estimated distance")
#ggsave(plot, file = paste(results, "Within-Person Association Plot", ".png", sep = ""), units = "in", width = 6, height = 6)


```
```{r - Do estimates significantly differ from the position of the starting line at 0.9?}

by(data, data$combination, function (data) wilcox.test(subset(data, ground == 1)$estimateddistance, mu = 0.9, alternative = "greater", conf.int = T)) 
by(data, data$combination, function (data) wilcox.test(subset(data, ground == 2)$estimateddistance, mu = 0.9, alternative = "greater", conf.int = T)) 

# report:
report(wilcox.test(subset(data, ground == 2 & combination == 2)$estimateddistance, mu = 0.9, alternative = "greater"))
```

```{r - modelling the variables}
modelall <- lmer(estimateddistance ~ traveldistance + as.factor(travelvelocity) + ground * combination + (1 | id), data)

# Test for Multicollinearity
vif(modelall) #
barplot(vif(modelall) , main = "VIF Values", horiz = TRUE, col = "steelblue")
abline(v = 5, lwd = 3, lty = 2) #add vertical line at 5

summary(modelall)
report(modelall)

report(anova(modelall))

model_parameters(anova(modelall))

model_parameters(modelall)
model_parameters(anova(modelall))

model_performance(modelall) # ICC subject variability .340

# Post hoc analysis
# mein effect ground
emmeans(modelall, list(pairwise ~ ground), adjust = "tukey")#, pbkrtest.limit = 8976)

#mein effect combination
emmeans(modelall, list(pairwise ~ combination), adjust = "tukey")#, pbkrtest.limit = 8976)

# interaction effect
emmeans(modelall, list(pairwise ~ ground*combination), adjust = "tukey")#, pbkrtest.limit = 8976)

# Kontrast analysis
estimate_contrasts(modelall, contrast = c("combination", "ground"))
estimate_means(modelall)
emmeans(modelall)
ranef(modelall) 
```


# Inferential Plots
```{r - plots of the lmer models}
# Remember:
#modelall <- lmer(estimateddistance ~ traveldistance + travelvelocity + ground * combination + (1 | id), data)

# QQ Plots
qplot(data = subset(data, travelvelocity == 0.3965), estimateddistance, geom = "density")
qqmath(subset(data, travelvelocity == 0.3965)$estimateddistance)
qplot(data = subset(data, travelvelocity == 0.7930), estimateddistance, geom = "density")
qqmath(subset(data, travelvelocity == 0.7930)$estimateddistance)
qplot(data = subset(data, travelvelocity == 1.1895), estimateddistance, geom = "density")
qqmath(subset(data, travelvelocity == 1.1895)$estimateddistance)


# Model Plots main effects
plot <- plot_model(model = modelall, type = "pred")
ggsave(plot$traveldistance, file = paste(results, "model estimated distance", ".pdf", sep = ""), units = "in", width = 6, height = 6)
ggsave(plot$travelvelocity, file = paste(results, "model traveled velocity", ".pdf", sep = ""), units = "in", width = 6, height = 6)
ggsave(plot$ground, file = paste(results, "model ground", ".pdf", sep = ""), units = "in", width = 6, height = 6)
ggsave(plot$combination, file = paste(results, "model combination", ".pdf", sep = ""), units = "in", width = 6, height = 6)


# Model Plots Interaction ground * combination
plot <- plot_model(model = modelall, type = "pred", terms = c("ground", "combination")) +
  ggtitle("slow vs normal: predicted values of the estimated distance") +
  scale_y_continuous(limits = c(0, 10)) +
  scale_x_continuous(name = "Ground", breaks = c(1, 2), labels = c("gravel", "stripes"))
ggsave(plot, file = paste(results, "model predicted values of the estimated distance", ".pdf", sep = ""), units = "in", width = 6, height = 6)

```


